
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Управление опросом ЖКХ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .admin-navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1a252f 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 1rem 0;
        }
        
        .container-fluid.py-4 {
            padding: 2rem 15px !important;
        }
        
        .row.gutter-fix {
            margin-right: -10px;
            margin-left: -10px;
        }
        
        .row.gutter-fix > [class*="col-"] {
            padding-right: 10px;
            padding-left: 10px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 20px;
            background: white;
            height: auto;
            min-height: 200px;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .card-header {
            border-bottom: none;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
            color: white;
        }
        
        .card-header.bg-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #2ecc71 100%);
        }
        
        .card-header.bg-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c0392b 100%);
        }
        
        .card-header.bg-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #2980b9 100%);
        }
        
        .card-header.bg-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d35400 100%);
        }
        
        .card-body {
            padding: 1.5rem;
            height: auto;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-change {
            font-size: 0.85rem;
            padding: 3px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .change-up { background: rgba(39, 174, 96, 0.15); color: var(--success-color); }
        .change-down { background: rgba(231, 76, 60, 0.15); color: var(--danger-color); }
        
        .data-table {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .data-table th {
            font-weight: 600;
            color: var(--primary-color);
            border-top: none;
        }
        
        .vote-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-new { background: rgba(52, 152, 219, 0.15); color: var(--secondary-color); }
        .status-verified { background: rgba(39, 174, 96, 0.15); color: var(--success-color); }
        .status-duplicate { background: rgba(243, 156, 18, 0.15); color: var(--warning-color); }
        
        .btn-admin {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-floating {
            margin-bottom: 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @media (max-width: 768px) {
            .stat-number {
                font-size: 1.8rem;
            }
            
            .btn-admin {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .dashboard-card {
                margin-bottom: 15px;
            }
        }
        
        #loginSection {
            min-height: 70vh;
            display: flex;
            align-items: center;
        }
        
        #loginSection .dashboard-card {
            margin: 0 auto;
            max-width: 400px;
            width: 100%;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .drop-zone:hover {
            border-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .progress {
            height: 6px;
            border-radius: 3px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark admin-navbar">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <div class="position-relative me-3">
                    <i class="fas fa-user-shield fa-xl"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </div>
                <div>
                    <div class="fw-bold">Панель администратора</div>
                    <small class="opacity-75">Опрос качества ЖКХ</small>
                </div>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="adminNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-vote-yea me-1"></i> Голосовать
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="results.html">
                            <i class="fas fa-chart-bar me-1"></i> Результаты
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-cog me-1"></i> Администрирование
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#dashboard"><i class="fas fa-tachometer-alt me-2"></i>Дашборд</a></li>
                            <li><a class="dropdown-item" href="#votes"><i class="fas fa-list-check me-2"></i>Управление голосами</a></li>
                            <li><a class="dropdown-item" href="#export"><i class="fas fa-download me-2"></i>Экспорт данных</a></li>
                            <li><a class="dropdown-item" href="#settings"><i class="fas fa-cogs me-2"></i>Настройки</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Выйти</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm ms-2" onclick="toggleDarkMode()">
                            <i class="fas fa-moon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Главный контейнер -->
    <div class="container-fluid py-4">
        <!-- Система аутентификации -->
        <div id="loginSection" class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="dashboard-card fade-in-up">
                    <div class="card-header bg-primary">
                        <h5 class="mb-0"><i class="fas fa-lock"></i> Аутентификация</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <i class="fas fa-user-shield fa-3x text-primary mb-3"></i>
                            <h4>Доступ только для администраторов</h4>
                            <p class="text-muted">Введите пароль для продолжения</p>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-floating">
                                <input type="password" class="form-control" id="adminPassword" 
                                       placeholder="Пароль администратора" value="admin123">
                                <label for="adminPassword"><i class="fas fa-key me-2"></i>Пароль администратора</label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="showPassword">
                                <label class="form-check-label small" for="showPassword">
                                    Показать пароль
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-admin w-100" onclick="login()">
                            <i class="fas fa-sign-in-alt me-2"></i> Войти в систему
                        </button>
                        
                        <div class="alert alert-info mt-4 small">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>По умолчанию пароль:</strong> <code>admin123</code><br>
                            Рекомендуется изменить пароль после первого входа
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Основной дашборд (скрыт до входа) -->
        <div id="adminDashboard" style="display: none;">
            <!-- Заголовок дашборда -->
            <div class="row gutter-fix mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1">Административный дашборд</h3>
                            <p class="text-muted mb-0" id="dashboardSubtitle">
                                <i class="fas fa-sync-alt fa-spin me-2"></i>Загрузка данных...
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="showHelp()">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Основные показатели -->
            <div class="row gutter-fix mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="dashboard-card h-100">
                        <div class="card-header bg-primary">
                            <h6 class="mb-0"><i class="fas fa-users me-2"></i>Всего голосов</h6>
                        </div>
                        <div class="card-body text-center py-4">
                            <div class="stat-number" id="totalVotesAdmin">0</div>
                            <div class="text-muted">Всего ответов</div>
                            <div class="small mt-2">
                                <span class="stat-change change-up" id="votesChange">+0%</span> за неделю
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="dashboard-card h-100">
                        <div class="card-header bg-success">
                            <h6 class="mb-0"><i class="fas fa-home me-2"></i>Уникальные адреса</h6>
                        </div>
                        <div class="card-body text-center py-4">
                            <div class="stat-number" id="uniqueAddressesAdmin">0</div>
                            <div class="text-muted">Отдельных домов</div>
                            <div class="d-flex justify-content-between small mt-3">
                                <span>Охват района:</span>
                                <span class="fw-bold" id="coveragePercent">0%</span>
                            </div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-success" id="coverageBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="dashboard-card h-100">
                        <div class="card-header bg-info">
                            <h6 class="mb-0"><i class="fas fa-star-half-alt me-2"></i>Средняя оценка</h6>
                        </div>
                        <div class="card-body text-center py-4">
                            <div class="stat-number" id="avgRatingAdmin">0.0</div>
                            <div class="text-muted">из 5 возможных</div>
                            <div class="rating-stars mt-2" style="font-size: 1.2rem;">
                                <i class="fas fa-star" id="star1"></i>
                                <i class="fas fa-star" id="star2"></i>
                                <i class="fas fa-star" id="star3"></i>
                                <i class="fas fa-star" id="star4"></i>
                                <i class="fas fa-star" id="star5"></i>
                            </div>
                            <div class="small mt-2">
                                <span class="stat-change change-up" id="ratingChange">+0%</span> за месяц
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="dashboard-card h-100">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Активность</h6>
                        </div>
                        <div class="card-body text-center py-4">
                            <div class="stat-number" id="todayActivity">0</div>
                            <div class="text-muted">Голосов сегодня</div>
                            <div class="d-flex justify-content-between small mt-3">
                                <span>Вчера:</span>
                                <span id="yesterdayActivity">0</span>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <span>За неделю:</span>
                                <span id="weeklyActivity">0</span>
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-primary" id="peakHour">Пик: --:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Основной контент -->
            <div class="row gutter-fix">
                <!-- Левая колонка: Управление данными -->
                <div class="col-lg-8">
                    <!-- Управление голосами -->
                    <div class="dashboard-card">
                        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-list-check me-2"></i> Управление голосами</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-light" onclick="filterVotes('all')">Все</button>
                                <button class="btn btn-sm btn-outline-light" onclick="filterVotes('today')">Сегодня</button>
                                <button class="btn btn-sm btn-outline-light" onclick="filterVotes('week')">Неделя</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table data-table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50">ID</th>
                                            <th>Адрес</th>
                                            <th>Оценка</th>
                                            <th>Дата</th>
                                            <th>Статус</th>
                                            <th width="100">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="votesTable">
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                                Загрузка голосов...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small class="text-muted" id="votesInfo">Загружено 0 голосов</small>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadMoreVotes()">
                                        <i class="fas fa-plus me-1"></i> Загрузить еще
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal()">
                                        <i class="fas fa-filter-circle-xmark me-1"></i> Фильтровать
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Быстрые операции -->
                    <div class="dashboard-card">
                        <div class="card-header bg-info">
                            <h6 class="mb-0"><i class="fas fa-bolt me-2"></i> Быстрые операции</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <button class="btn btn-outline-success w-100 btn-admin" onclick="exportCSV()">
                                        <i class="fas fa-file-csv me-2"></i> Экспорт в CSV
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-warning w-100 btn-admin" onclick="cleanupDatabase()">
                                        <i class="fas fa-broom me-2"></i> Очистка БД
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-primary w-100 btn-admin" onclick="backupData()">
                                        <i class="fas fa-database me-2"></i> Резервная копия
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Правая колонка: Инструменты -->
                <div class="col-lg-4">
                    <!-- Экспорт данных -->
                    <div class="dashboard-card">
                        <div class="card-header bg-success">
                            <h6 class="mb-0"><i class="fas fa-download me-2"></i> Экспорт данных</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small">Формат экспорта</label>
                                <select class="form-select" id="exportFormat">
                                    <option value="json">JSON (полные данные)</option>
                                    <option value="csv">CSV (таблица Excel)</option>
                                    <option value="pdf">PDF (отчёт)</option>
                                    <option value="excel">Excel XLSX</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small">Период данных</label>
                                <select class="form-select" id="exportPeriod">
                                    <option value="all">Все данные</option>
                                    <option value="week">Последняя неделя</option>
                                    <option value="month">Последний месяц</option>
                                    <option value="custom">Выбрать период...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3" id="customDates" style="display: none;">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" class="form-control form-control-sm" id="startDate">
                                    </div>
                                    <div class="col-6">
                                        <input type="date" class="form-control form-control-sm" id="endDate">
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-success w-100 btn-admin" onclick="exportData()">
                                <i class="fas fa-file-export me-2"></i> Экспортировать данные
                            </button>
                            
                            <div class="alert alert-light mt-3 small">
                                <i class="fas fa-info-circle text-info me-2"></i>
                                Экспорт включает адреса, оценки, время и комментарии
                            </div>
                        </div>
                    </div>

                    <!-- Настройки -->
                    <div class="dashboard-card">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0"><i class="fas fa-cogs me-2"></i> Настройки системы</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small">Название района</label>
                                <input type="text" class="form-control" id="districtNameInput" 
                                       value="Заднепровский район">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small">Новый пароль администратора</label>
                                <input type="password" class="form-control" id="newPassword" 
                                       placeholder="Введите новый пароль">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small">Повторите пароль</label>
                                <input type="password" class="form-control" id="confirmPassword" 
                                       placeholder="Повторите пароль">
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableNotifications">
                                    <label class="form-check-label small" for="enableNotifications">
                                        Уведомления о новых голосах
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn btn-warning w-100 btn-admin" onclick="saveSettings()">
                                <i class="fas fa-save me-2"></i> Сохранить настройки
                            </button>
                        </div>
                    </div>

                    <!-- Импорт данных -->
                    <div class="dashboard-card">
                        <div class="card-header bg-info">
                            <h6 class="mb-0"><i class="fas fa-upload me-2"></i> Импорт данных</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="drop-zone" id="dropZone">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-3"></i>
                                    <p class="mb-2">Перетащите файлы сюда</p>
                                    <p class="small text-muted">или кликните для выбора</p>
                                    <input type="file" id="importFiles" multiple accept=".json,.csv" style="display: none;">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="fileInfo">Выбрано файлов: 0</small>
                                <button class="btn btn-sm btn-info" id="importBtn" disabled onclick="importData()">
                                    <i class="fas fa-file-import me-1"></i> Импортировать
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Опасные операции -->
            <div class="row gutter-fix mt-4">
                <div class="col-12">
                    <div class="dashboard-card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="fas fa-triangle-exclamation me-2"></i> Опасные операции</h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Внимание!</strong> Эти операции необратимы. Создайте резервную копию перед выполнением.
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <button class="btn btn-outline-danger w-100 btn-admin" onclick="removeDuplicates()">
                                        <i class="fas fa-copy me-2"></i> Удалить дубликаты
                                    </button>
                                    <small class="text-muted d-block mt-1">Один адрес - один голос</small>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-danger w-100 btn-admin" onclick="removeOldVotes()">
                                        <i class="fas fa-calendar-times me-2"></i> Удалить старые
                                    </button>
                                    <small class="text-muted d-block mt-1">Старше 30 дней</small>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-danger w-100 btn-admin" onclick="showResetModal()">
                                        <i class="fas fa-bomb me-2"></i> Сбросить всё
                                    </button>
                                    <small class="text-muted d-block mt-1">Полная очистка</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Подвал -->
    <footer class="footer mt-5 py-4 bg-dark text-white">
        <div class="container text-center">
            <p class="small mb-0">
                <i class="fas fa-user-shield me-2"></i> Административная панель • Опрос ЖКХ • Версия 2.0
            </p>
        </div>
    </footer>

    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Глобальные переменные
        const ADMIN_CONFIG = {
            password: "admin123",
            defaultDistrict: "Заднепровский район",
            itemsPerPage: 15,
            firebaseConfig: {
                apiKey: "AIzaSyA9x1ZcFgHjklmnoiT2XqPq3RzABCDEFGH",
                authDomain: "poll-hope-11.firebaseapp.com",
                databaseURL: "https://poll-hope-11-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "poll-hope-11",
                storageBucket: "poll-hope-11.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdef1234567890"
            }
        };
        
        let currentUser = null;
        let allVotes = [];
        let currentPage = 1;
        let filesToImport = [];
        let currentFilter = 'all';
        let filteredVotes = [];
        let db = null;
        let firebaseInitialized = false;

        // ==================== FIREBASE ИНИЦИАЛИЗАЦИЯ ====================
        async function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    await loadFirebaseSDK();
                }
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(ADMIN_CONFIG.firebaseConfig);
                }
                
                db = firebase.database();
                firebaseInitialized = true;
                console.log("Firebase initialized successfully");
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showNotification('error', 'Ошибка Firebase', 'Не удалось подключиться к базе данных');
            }
        }

        async function loadFirebaseSDK() {
            return new Promise((resolve, reject) => {
                const script1 = document.createElement('script');
                script1.src = "https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js";
                
                script1.onload = () => {
                    const script2 = document.createElement('script');
                    script2.src = "https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js";
                    
                    script2.onload = () => resolve();
                    script2.onerror = () => reject(new Error("Failed to load Firebase Database"));
                    document.head.appendChild(script2);
                };
                
                script1.onerror = () => reject(new Error("Failed to load Firebase App"));
                document.head.appendChild(script1);
            });
        }

        // ==================== АУТЕНТИФИКАЦИЯ ====================
        function login() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_CONFIG.password) {
                currentUser = {
                    name: "Администратор",
                    loginTime: new Date()
                };
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                
                // Инициализируем Firebase и загружаем данные
                initializeFirebase().then(() => {
                    loadAdminData();
                });
                
                updateTime();
                setInterval(updateTime, 60000);
                
                showNotification('success', 'Вход выполнен успешно', `Добро пожаловать, ${currentUser.name}!`);
                
            } else {
                showNotification('error', 'Ошибка входа', 'Неверный пароль администратора');
            }
        }
        
        function logout() {
            if (confirm('Вы действительно хотите выйти?')) {
                currentUser = null;
                document.getElementById('adminDashboard').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                showNotification('info', 'Выход выполнен', 'Вы вышли из системы');
            }
        }

        // ==================== ЗАГРУЗКА ДАННЫХ ====================
        async function loadAdminData() {
            showSpinner('Загрузка данных...');
            
            try {
                // Загружаем голоса из Firebase
                const votes = await fetchVotes();
                allVotes = votes;
                filteredVotes = [...votes];
                
                // Обновляем дашборд
                updateDashboardStats(votes);
                updateVotesTable(votes);
                updateNotifications();
                
                // Обновляем подзаголовок
                document.getElementById('dashboardSubtitle').innerHTML = 
                    `<i class="fas fa-check-circle text-success me-2"></i>` +
                    `Данные загружены • ${votes.length} голосов • ` +
                    `${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}`;
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                document.getElementById('dashboardSubtitle').innerHTML = 
                    `<i class="fas fa-exclamation-triangle text-danger me-2"></i>` +
                    `Ошибка загрузки: ${error.message}`;
                
                showNotification('error', 'Ошибка загрузки', 'Не удалось загрузить данные из базы');
            } finally {
                hideSpinner();
            }
        }
        
        async function fetchVotes() {
            if (!firebaseInitialized || !db) {
                throw new Error("Firebase не инициализирован");
            }
            
            const snapshot = await db.ref('votes').once('value');
            const data = snapshot.val();
            
            if (!data) {
                return [];
            }
            
            // Преобразуем объект в массив
            const votesArray = Object.keys(data).map(key => ({
                id: key,
                ...data[key]
            }));
            
            // Сортируем по дате (новые первые)
            return votesArray.sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
        }

        async function saveVoteToFirebase(vote) {
            if (!firebaseInitialized || !db) {
                throw new Error("Firebase не инициализирован");
            }
            
            await db.ref('votes/' + vote.id).set(vote);
        }

        async function deleteVoteFromFirebase(voteId) {
            if (!firebaseInitialized || !db) {
                throw new Error("Firebase не инициализирован");
            }
            
            await db.ref('votes/' + voteId).remove();
        }

        async function clearAllVotesFromFirebase() {
            if (!firebaseInitialized || !db) {
                throw new Error("Firebase не инициализирован");
            }
            
            await db.ref('votes').remove();
        }

        // ==================== ОБНОВЛЕНИЕ СТАТИСТИКИ ====================
        function updateDashboardStats(votes) {
            const stats = calculateStats(votes);
            
            // Основные показатели
            document.getElementById('totalVotesAdmin').textContent = stats.totalVotes;
            document.getElementById('uniqueAddressesAdmin').textContent = stats.uniqueAddresses;
            document.getElementById('avgRatingAdmin').textContent = stats.averageRating;
            document.getElementById('todayActivity').textContent = stats.todayVotes;
            document.getElementById('yesterdayActivity').textContent = stats.yesterdayVotes;
            document.getElementById('weeklyActivity').textContent = stats.weeklyVotes;
            
            // Изменения
            document.getElementById('votesChange').textContent = stats.votesChange >= 0 ? 
                `+${stats.votesChange}%` : `${stats.votesChange}%`;
            document.getElementById('votesChange').className = stats.votesChange >= 0 ? 
                'stat-change change-up' : 'stat-change change-down';
            
            document.getElementById('ratingChange').textContent = stats.ratingChange >= 0 ? 
                `+${stats.ratingChange}%` : `${stats.ratingChange}%`;
            document.getElementById('ratingChange').className = stats.ratingChange >= 0 ? 
                'stat-change change-up' : 'stat-change change-down';
            
            // Охват района
            const coverage = Math.min(100, Math.round((stats.uniqueAddresses / 100) * 100));
            document.getElementById('coveragePercent').textContent = `${coverage}%`;
            document.getElementById('coverageBar').style.width = `${coverage}%`;
            
            // Звёзды рейтинга
            updateStars(stats.averageRating);
            
            // Пиковый час
            document.getElementById('peakHour').textContent = `Пик: ${stats.peakHour || '--:--'}`;
        }
        
        function calculateStats(votes) {
            if (votes.length === 0) {
                return {
                    totalVotes: 0,
                    uniqueAddresses: 0,
                    averageRating: '0.0',
                    todayVotes: 0,
                    yesterdayVotes: 0,
                    weeklyVotes: 0,
                    votesChange: 0,
                    ratingChange: 0,
                    peakHour: null
                };
            }
            
            const totalVotes = votes.length;
            
            // Уникальные адреса
            const addresses = new Set();
            votes.forEach(v => {
                if (v.street && v.house) {
                    addresses.add(`${v.street}, ${v.house}`);
                }
            });
            
            // Средний рейтинг
            let totalRating = 0;
            let ratingCount = 0;
            
            votes.forEach(vote => {
                if (vote.answers && Array.isArray(vote.answers)) {
                    vote.answers.forEach(answer => {
                        const value = parseInt(answer.value);
                        if (!isNaN(value)) {
                            totalRating += value;
                            ratingCount++;
                        }
                    });
                }
            });
            
            const averageRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : "0.0";
            
            // Активность
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            const weekAgo = new Date(Date.now() - 7 * 86400000);
            
            const todayVotes = votes.filter(v => 
                new Date(v.timestamp).toDateString() === today
            ).length;
            
            const yesterdayVotes = votes.filter(v => 
                new Date(v.timestamp).toDateString() === yesterday
            ).length;
            
            const weeklyVotes = votes.filter(v => 
                new Date(v.timestamp) > weekAgo
            ).length;
            
            // Изменения (рассчитываем реальные)
            const lastWeekVotes = votes.filter(v => {
                const weekAgo = new Date(Date.now() - 7 * 86400000);
                const twoWeeksAgo = new Date(Date.now() - 14 * 86400000);
                const voteDate = new Date(v.timestamp);
                return voteDate > twoWeeksAgo && voteDate <= weekAgo;
            }).length;
            
            const votesChange = lastWeekVotes > 0 ? 
                Math.round(((weeklyVotes - lastWeekVotes) / lastWeekVotes) * 100) : 0;
            
            // Пиковый час
            const hourCounts = new Array(24).fill(0);
            votes.forEach(v => {
                const hour = new Date(v.timestamp).getHours();
                hourCounts[hour]++;
            });
            
            const peakHourIndex = hourCounts.indexOf(Math.max(...hourCounts));
            const peakHour = peakHourIndex.toString().padStart(2, '0') + ':00';
            
            return {
                totalVotes,
                uniqueAddresses: addresses.size,
                averageRating,
                todayVotes,
                yesterdayVotes,
                weeklyVotes,
                votesChange,
                ratingChange: 5, // Для примера
                peakHour
            };
        }
        
        function updateStars(rating) {
            const numRating = parseFloat(rating);
            
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star${i}`);
                if (i <= numRating) {
                    star.className = 'fas fa-star text-warning';
                } else if (i - 0.5 <= numRating) {
                    star.className = 'fas fa-star-half-alt text-warning';
                } else {
                    star.className = 'far fa-star text-muted';
                }
            }
        }

        // ==================== УПРАВЛЕНИЕ ГОЛОСАМИ ====================
        function updateVotesTable(votes) {
            const tableBody = document.getElementById('votesTable');
            const startIndex = (currentPage - 1) * ADMIN_CONFIG.itemsPerPage;
            const endIndex = startIndex + ADMIN_CONFIG.itemsPerPage;
            const pageVotes = votes.slice(startIndex, endIndex);
            
            if (pageVotes.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p class="mb-0">Нет данных для отображения</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            pageVotes.forEach((vote, index) => {
                const time = new Date(vote.timestamp).toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const date = new Date(vote.timestamp).toLocaleDateString('ru-RU');
                
                // Средний рейтинг для этого голоса
                let avgRating = 0;
                if (vote.answers && vote.answers.length > 0) {
                    const sum = vote.answers.reduce((acc, ans) => acc + parseInt(ans.value), 0);
                    avgRating = (sum / vote.answers.length).toFixed(1);
                }
                
                // Статус (определяем по дате)
                const voteDate = new Date(vote.timestamp);
                const now = new Date();
                const diffHours = (now - voteDate) / (1000 * 60 * 60);
                
                let status = 'status-verified';
                let statusText = 'Проверен';
                
                if (diffHours < 24) {
                    status = 'status-new';
                    statusText = 'Новый';
                }
                
                html += `
                    <tr>
                        <td><small class="text-muted">${startIndex + index + 1}</small></td>
                        <td>
                            <div class="fw-semibold">${vote.street || 'Не указано'}, ${vote.house || 'Не указано'}</div>
                            <small class="text-muted">${vote.entrance ? 'Подъезд ' + vote.entrance : 'Подъезд не указан'}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">${avgRating}/5</span>
                        </td>
                        <td>
                            <div>${date}</div>
                            <small class="text-muted">${time}</small>
                        </td>
                        <td>
                            <span class="vote-status ${status}">${statusText}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewVote('${vote.id}')" title="Просмотр">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteVote('${vote.id}')" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('votesInfo').textContent = 
                `Показано ${startIndex + 1}-${Math.min(endIndex, votes.length)} из ${votes.length} голосов`;
        }
        
        function filterVotes(filterType) {
            currentFilter = filterType;
            currentPage = 1;
            
            switch(filterType) {
                case 'today':
                    const today = new Date().toDateString();
                    filteredVotes = allVotes.filter(v => 
                        new Date(v.timestamp).toDateString() === today
                    );
                    break;
                    
                case 'week':
                    const weekAgo = new Date(Date.now() - 7 * 86400000);
                    filteredVotes = allVotes.filter(v => 
                        new Date(v.timestamp) > weekAgo
                    );
                    break;
                    
                case 'all':
                default:
                    filteredVotes = [...allVotes];
                    break;
            }
            
            updateVotesTable(filteredVotes);
        }
        
        function loadMoreVotes() {
            currentPage++;
            updateVotesTable(filteredVotes);
        }
        
        async function deleteVote(voteId) {
            if (!confirm('Вы действительно хотите удалить этот голос?')) {
                return;
            }
            
            showSpinner('Удаление голоса...');
            
            try {
                // Удаляем из Firebase
                await deleteVoteFromFirebase(voteId);
                
                // Удаляем из локального массива
                allVotes = allVotes.filter(v => v.id !== voteId);
                filteredVotes = filteredVotes.filter(v => v.id !== voteId);
                
                // Обновляем интерфейс
                updateDashboardStats(allVotes);
                updateVotesTable(filteredVotes);
                updateNotifications();
                
                showNotification('success', 'Удаление голоса', 'Голос успешно удалён');
                
            } catch (error) {
                console.error('Ошибка удаления голоса:', error);
                showNotification('error', 'Ошибка удаления', 'Не удалось удалить голос');
            } finally {
                hideSpinner();
            }
        }
        
        function viewVote(voteId) {
            const vote = allVotes.find(v => v.id === voteId);
            if (!vote) return;
            
            let details = `
                <strong>Адрес:</strong> ${vote.street}, ${vote.house}${vote.entrance ? `, подъезд ${vote.entrance}` : ''}<br>
                <strong>Дата:</strong> ${new Date(vote.timestamp).toLocaleString('ru-RU')}<br>
                <strong>Район:</strong> ${vote.district || 'Не указан'}<br><br>
                <strong>Ответы:</strong><br>
            `;
            
            if (vote.answers && Array.isArray(vote.answers)) {
                vote.answers.forEach((answer, index) => {
                    details += `${index + 1}. ${answer.question}: ${answer.value}/5<br>`;
                });
            }
            
            if (vote.comment) {
                details += `<br><strong>Комментарий:</strong><br>${vote.comment}`;
            }
            
            showConfirmationModal(
                'Просмотр голоса',
                details,
                'Закрыть',
                () => {}
            );
        }
        
        function showDeleteModal() {
            showConfirmationModal(
                'Фильтрация голосов',
                `
                <div class="mb-3">
                    <label class="form-label">Удалить голосы по критерию:</label>
                    <select class="form-select" id="deleteCriteria">
                        <option value="old">Старше 30 дней</option>
                        <option value="duplicates">Дубликаты адресов</option>
                        <option value="low_rating">С оценкой ниже 2</option>
                        <option value="no_address">Без адреса</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Подтвердите пароль:</label>
                    <input type="password" class="form-control" id="deletePassword" placeholder="Введите пароль администратора">
                </div>
                `,
                'Удалить',
                async () => {
                    const password = document.getElementById('deletePassword').value;
                    const criteria = document.getElementById('deleteCriteria').value;
                    
                    if (password !== ADMIN_CONFIG.password) {
                        showNotification('error', 'Ошибка', 'Неверный пароль');
                        return;
                    }
                    
                    await performBulkDelete(criteria);
                }
            );
        }
        
        async function performBulkDelete(criteria) {
            showSpinner('Выполнение массового удаления...');
            
            try {
                let votesToDelete = [];
                
                switch(criteria) {
                    case 'old':
                        const monthAgo = new Date(Date.now() - 30 * 86400000);
                        votesToDelete = allVotes.filter(v => new Date(v.timestamp) < monthAgo);
                        break;
                        
                    case 'duplicates':
                        const addressMap = new Map();
                        votesToDelete = [];
                        
                        // Находим дубликаты (оставляем самый новый)
                        allVotes.forEach(vote => {
                            const addressKey = `${vote.street}-${vote.house}-${vote.entrance}`;
                            if (addressMap.has(addressKey)) {
                                const existing = addressMap.get(addressKey);
                                // Оставляем самый новый, удаляем старый
                                if (new Date(vote.timestamp) > new Date(existing.timestamp)) {
                                    votesToDelete.push(existing);
                                    addressMap.set(addressKey, vote);
                                } else {
                                    votesToDelete.push(vote);
                                }
                            } else {
                                addressMap.set(addressKey, vote);
                            }
                        });
                        break;
                        
                    case 'low_rating':
                        votesToDelete = allVotes.filter(vote => {
                            if (!vote.answers || !Array.isArray(vote.answers)) return false;
                            const avg = vote.answers.reduce((sum, ans) => sum + parseInt(ans.value), 0) / vote.answers.length;
                            return avg < 2;
                        });
                        break;
                        
                    case 'no_address':
                        votesToDelete = allVotes.filter(v => !v.street || !v.house);
                        break;
                }
                
                if (votesToDelete.length === 0) {
                    showNotification('info', 'Удаление', 'Нет голосов для удаления по выбранному критерию');
                    return;
                }
                
                // Удаляем из Firebase
                for (const vote of votesToDelete) {
                    await deleteVoteFromFirebase(vote.id);
                }
                
                // Обновляем локальные данные
                allVotes = allVotes.filter(v => !votesToDelete.some(del => del.id === v.id));
                filteredVotes = filteredVotes.filter(v => !votesToDelete.some(del => del.id === v.id));
                
                // Обновляем интерфейс
                updateDashboardStats(allVotes);
                updateVotesTable(filteredVotes);
                updateNotifications();
                
                showNotification('success', 'Массовое удаление', `Удалено ${votesToDelete.length} голосов`);
                
            } catch (error) {
                console.error('Ошибка массового удаления:', error);
                showNotification('error', 'Ошибка удаления', 'Не удалось выполнить массовое удаление');
            } finally {
                hideSpinner();
            }
        }

        // ==================== ЭКСПОРТ ДАННЫХ ====================
        function exportData() {
            const format = document.getElementById('exportFormat').value;
            const period = document.getElementById('exportPeriod').value;
            
            let exportVotes = [...allVotes];
            
            // Фильтрация по периоду
            if (period === 'week') {
                const weekAgo = new Date(Date.now() - 7 * 86400000);
                exportVotes = exportVotes.filter(v => new Date(v.timestamp) > weekAgo);
            } else if (period === 'month') {
                const monthAgo = new Date(Date.now() - 30 * 86400000);
                exportVotes = exportVotes.filter(v => new Date(v.timestamp) > monthAgo);
            } else if (period === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    
                    exportVotes = exportVotes.filter(v => {
                        const voteDate = new Date(v.timestamp);
                        return voteDate >= start && voteDate <= end;
                    });
                }
            }
            
            if (exportVotes.length === 0) {
                showNotification('warning', 'Экспорт', 'Нет данных для экспорта по выбранному периоду');
                return;
            }
            
            // Экспорт в выбранном формате
            switch(format) {
                case 'json':
                    exportJSON(exportVotes);
                    break;
                case 'csv':
                    exportCSV(exportVotes);
                    break;
                case 'pdf':
                    exportPDF(exportVotes);
                    break;
                case 'excel':
                    exportExcel(exportVotes);
                    break;
            }
        }
        
        function exportJSON(votes) {
            const data = {
                exportDate: new Date().toISOString(),
                totalVotes: votes.length,
                votes: votes,
                district: ADMIN_CONFIG.defaultDistrict,
                statistics: calculateStats(votes)
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            downloadFile(jsonString, `jkh-poll-export-${new Date().toISOString().slice(0,10)}.json`, 'application/json');
            showNotification('success', 'Экспорт JSON', 
                `Экспортировано ${votes.length} голосов`);
        }
        
        function exportCSV(votes) {
            // Заголовки CSV
            let csv = 'Дата,Время,Район,Улица,Дом,Подъезд,';
            
            // Добавляем заголовки для вопросов
            for (let i = 1; i <= 5; i++) {
                csv += `Вопрос${i},`;
            }
            
            csv += 'Средняя оценка,ID\n';
            
            // Данные
            votes.forEach(vote => {
                const date = new Date(vote.timestamp).toLocaleDateString('ru-RU');
                const time = new Date(vote.timestamp).toLocaleTimeString('ru-RU');
                
                // Ответы
                const answers = vote.answers || [];
                const answerValues = [];
                
                for (let i = 0; i < 5; i++) {
                    answerValues.push(answers[i]?.value || '');
                }
                
                // Средняя оценка
                let avg = 0;
                if (answers.length > 0) {
                    const sum = answers.reduce((acc, ans) => acc + parseInt(ans.value || 0), 0);
                    avg = (sum / answers.length).toFixed(1);
                }
                
                // Экранируем запятые в данных
                const escapeCSV = (str) => {
                    if (!str) return '';
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };
                
                csv += `${escapeCSV(date)},${escapeCSV(time)},${escapeCSV(vote.district || '')},` +
                       `${escapeCSV(vote.street || '')},${escapeCSV(vote.house || '')},` +
                       `${escapeCSV(vote.entrance || '')},` +
                       `${answerValues.map(escapeCSV).join(',')},` +
                       `${avg},${escapeCSV(vote.id)}\n`;
            });
            
            downloadFile(csv, `jkh-poll-export-${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
            showNotification('success', 'Экспорт CSV', 
                `Экспортировано ${votes.length} голосов`);
        }
        
        function exportPDF(votes) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Заголовок
                doc.setFontSize(16);
                doc.text('Отчёт по опросу ЖКХ', 20, 20);
                doc.setFontSize(12);
                doc.text(`Район: ${ADMIN_CONFIG.defaultDistrict}`, 20, 30);
                doc.text(`Дата экспорта: ${new Date().toLocaleString('ru-RU')}`, 20, 37);
                doc.text(`Всего голосов: ${votes.length}`, 20, 44);
                
                // Статистика
                const stats = calculateStats(votes);
                doc.text(`Уникальных адресов: ${stats.uniqueAddresses}`, 20, 51);
                doc.text(`Средняя оценка: ${stats.averageRating}/5`, 20, 58);
                
                // Таблица с голосами (первые 20)
                let y = 70;
                doc.setFontSize(10);
                
                // Заголовки таблицы
                doc.text('№', 20, y);
                doc.text('Адрес', 30, y);
                doc.text('Дата', 100, y);
                doc.text('Оценка', 140, y);
                
                y += 7;
                doc.line(20, y, 190, y);
                y += 3;
                
                // Данные
                votes.slice(0, 20).forEach((vote, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    const address = `${vote.street || ''}, ${vote.house || ''}`;
                    const date = new Date(vote.timestamp).toLocaleDateString('ru-RU');
                    
                    // Средняя оценка
                    let avgRating = 0;
                    if (vote.answers && vote.answers.length > 0) {
                        const sum = vote.answers.reduce((acc, ans) => acc + parseInt(ans.value), 0);
                        avgRating = (sum / vote.answers.length).toFixed(1);
                    }
                    
                    doc.text((index + 1).toString(), 20, y);
                    doc.text(address.substring(0, 30), 30, y);
                    doc.text(date, 100, y);
                    doc.text(avgRating.toString(), 140, y);
                    
                    y += 7;
                });
                
                if (votes.length > 20) {
                    doc.text(`... и ещё ${votes.length - 20} голосов`, 20, y);
                }
                
                doc.save(`jkh-poll-export-${new Date().toISOString().slice(0,10)}.pdf`);
                showNotification('success', 'Экспорт PDF', 
                    `Экспортировано ${votes.length} голосов в PDF`);
                
            } catch (error) {
                console.error('Ошибка экспорта PDF:', error);
                showNotification('error', 'Ошибка экспорта PDF', 'Не удалось создать PDF файл');
            }
        }
        
        function exportExcel(votes) {
            try {
                // Подготовка данных для Excel
                const data = [];
                
                // Заголовки
                data.push([
                    'Дата', 'Время', 'Район', 'Улица', 'Дом', 'Подъезд',
                    'Вопрос1', 'Вопрос2', 'Вопрос3', 'Вопрос4', 'Вопрос5',
                    'Средняя оценка', 'ID'
                ]);
                
                // Данные
                votes.forEach(vote => {
                    const date = new Date(vote.timestamp).toLocaleDateString('ru-RU');
                    const time = new Date(vote.timestamp).toLocaleTimeString('ru-RU');
                    
                    // Ответы
                    const answers = vote.answers || [];
                    const answerValues = [];
                    
                    for (let i = 0; i < 5; i++) {
                        answerValues.push(answers[i]?.value || '');
                    }
                    
                    // Средняя оценка
                    let avg = 0;
                    if (answers.length > 0) {
                        const sum = answers.reduce((acc, ans) => acc + parseInt(ans.value || 0), 0);
                        avg = (sum / answers.length).toFixed(1);
                    }
                    
                    data.push([
                        date, time, vote.district || '', vote.street || '', vote.house || '', vote.entrance || '',
                        ...answerValues, avg, vote.id
                    ]);
                });
                
                // Создание рабочей книги
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Голоса");
                
                // Добавляем лист со статистикой
                const stats = calculateStats(votes);
                const statsData = [
                    ['Статистика опроса'],
                    ['Район', ADMIN_CONFIG.defaultDistrict],
                    ['Дата экспорта', new Date().toLocaleString('ru-RU')],
                    ['Всего голосов', stats.totalVotes],
                    ['Уникальных адресов', stats.uniqueAddresses],
                    ['Средняя оценка', stats.averageRating],
                    ['Голосов сегодня', stats.todayVotes],
                    ['Голосов за неделю', stats.weeklyVotes],
                    ['Пиковый час активности', stats.peakHour]
                ];
                
                const wsStats = XLSX.utils.aoa_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, wsStats, "Статистика");
                
                // Сохранение файла
                XLSX.writeFile(wb, `jkh-poll-export-${new Date().toISOString().slice(0,10)}.xlsx`);
                showNotification('success', 'Экспорт Excel', 
                    `Экспортировано ${votes.length} голосов в Excel`);
                
            } catch (error) {
                console.error('Ошибка экспорта Excel:', error);
                showNotification('error', 'Ошибка экспорта Excel', 'Не удалось создать Excel файл');
            }
        }
        
        function exportCSV() {
            // Просто вызываем exportData с форматом CSV
            document.getElementById('exportFormat').value = 'csv';
            exportData();
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== БЫСТРЫЕ ОПЕРАЦИИ ====================
        async function cleanupDatabase() {
            if (!confirm('Выполнить очистку базы данных? Будут удалены пустые и некорректные записи.')) {
                return;
            }
            
            showSpinner('Очистка базы данных...');
            
            try {
                let cleanedCount = 0;
                
                // Находим некорректные записи
                const invalidVotes = allVotes.filter(vote => {
                    // Проверяем на наличие обязательных полей
                    if (!vote.street || !vote.house) return true;
                    if (!vote.answers || !Array.isArray(vote.answers) || vote.answers.length === 0) return true;
                    
                    // Проверяем корректность ответов
                    const invalidAnswers = vote.answers.some(answer => {
                        const value = parseInt(answer.value);
                        return isNaN(value) || value < 1 || value > 5;
                    });
                    
                    return invalidAnswers;
                });
                
                // Удаляем из Firebase
                for (const vote of invalidVotes) {
                    await deleteVoteFromFirebase(vote.id);
                    cleanedCount++;
                }
                
                // Обновляем локальные данные
                allVotes = allVotes.filter(v => !invalidVotes.some(iv => iv.id === v.id));
                filteredVotes = filteredVotes.filter(v => !invalidVotes.some(iv => iv.id === v.id));
                
                // Обновляем интерфейс
                updateDashboardStats(allVotes);
                updateVotesTable(filteredVotes);
                
                showNotification('success', 'Очистка БД', 
                    `Удалено ${cleanedCount} некорректных записей`);
                
            } catch (error) {
                console.error('Ошибка очистки БД:', error);
                showNotification('error', 'Ошибка очистки', 'Не удалось выполнить очистку базы данных');
            } finally {
                hideSpinner();
            }
        }
        
        async function backupData() {
            showSpinner('Создание резервной копии...');
            
            try {
                // Создаём полную резервную копию
                const backup = {
                    timestamp: new Date().toISOString(),
                    totalVotes: allVotes.length,
                    votes: allVotes,
                    district: ADMIN_CONFIG.defaultDistrict,
                    statistics: calculateStats(allVotes),
                    config: ADMIN_CONFIG
                };
                
                const jsonString = JSON.stringify(backup, null, 2);
                downloadFile(jsonString, `jkh-poll-backup-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`, 'application/json');
                
                showNotification('success', 'Резервная копия', 
                    `Создана резервная копия ${allVotes.length} голосов`);
                
            } catch (error) {
                console.error('Ошибка создания резервной копии:', error);
                showNotification('error', 'Ошибка резервного копирования', 'Не удалось создать резервную копию');
            } finally {
                hideSpinner();
            }
        }

        // ==================== ИМПОРТ ДАННЫХ ====================
        document.getElementById('dropZone').addEventListener('click', () => {
            document.getElementById('importFiles').click();
        });
        
        document.getElementById('importFiles').addEventListener('change', (event) => {
            filesToImport = Array.from(event.target.files);
            updateFileInfo();
        });
        
        function updateFileInfo() {
            const fileCount = filesToImport.length;
            const fileInfo = document.getElementById('fileInfo');
            const importBtn = document.getElementById('importBtn');
            
            fileInfo.textContent = `Выбрано файлов: ${fileCount}`;
            importBtn.disabled = fileCount === 0;
        }
        
        async function importData() {
            if (filesToImport.length === 0) {
                showNotification('warning', 'Импорт', 'Выберите файлы для импорта');
                return;
            }
            
            if (!confirm(`Импортировать ${filesToImport.length} файлов?`)) {
                return;
            }
            
            showSpinner('Импорт данных...');
            
            let totalImported = 0;
            let totalSkipped = 0;
            
            try {
                for (const file of filesToImport) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        if (data.votes && Array.isArray(data.votes)) {
                            for (const vote of data.votes) {
                                // Проверяем, нет ли уже такого голоса
                                const exists = allVotes.some(v => v.id === vote.id);
                                
                                if (!exists) {
                                    // Добавляем в Firebase
                                    await saveVoteToFirebase(vote);
                                    totalImported++;
                                } else {
                                    totalSkipped++;
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Ошибка обработки файла ${file.name}:`, error);
                    }
                }
                
                // Перезагружаем данные
                await loadAdminData();
                
                showNotification('success', 'Импорт завершён', 
                    `Импортировано: ${totalImported} голосов, пропущено (дубликаты): ${totalSkipped}`);
                
                // Сбрасываем список файлов
                filesToImport = [];
                updateFileInfo();
                document.getElementById('importFiles').value = '';
                
            } catch (error) {
                console.error('Ошибка импорта:', error);
                showNotification('error', 'Ошибка импорта', 'Не удалось импортировать данные');
            } finally {
                hideSpinner();
            }
        }

        // ==================== ОПАСНЫЕ ОПЕРАЦИИ ====================
        async function removeDuplicates() {
            if (!confirm('Удалить дубликаты голосов с одного адреса? Будет оставлен последний голос.')) {
                return;
            }
            
            showSpinner('Удаление дубликатов...');
            
            try {
                const addressMap = new Map();
                const duplicates = [];
                
                // Сортируем по дате (новые первые)
                const sortedVotes = [...allVotes].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                // Находим дубликаты
                sortedVotes.forEach(vote => {
                    const addressKey = `${vote.street}-${vote.house}-${vote.entrance}`;
                    if (addressMap.has(addressKey)) {
                        duplicates.push(vote);
                    } else {
                        addressMap.set(addressKey, vote);
                    }
                });
                
                if (duplicates.length === 0) {
                    showNotification('info', 'Удаление дубликатов', 'Дубликатов не найдено');
                    return;
                }
                
                // Удаляем дубликаты из Firebase
                for (const vote of duplicates) {
                    await deleteVoteFromFirebase(vote.id);
                }
                
                // Обновляем локальные данные
                allVotes = allVotes.filter(v => !duplicates.some(d => d.id === v.id));
                filteredVotes = filteredVotes.filter(v => !duplicates.some(d => d.id === v.id));
                
                // Обновляем интерфейс
                updateDashboardStats(allVotes);
                updateVotesTable(filteredVotes);
                
                showNotification('success', 'Удаление дубликатов', 
                    `Удалено ${duplicates.length} дубликатов`);
                
            } catch (error) {
                console.error('Ошибка удаления дубликатов:', error);
                showNotification('error', 'Ошибка удаления', 'Не удалось удалить дубликаты');
            } finally {
                hideSpinner();
            }
        }
        
        async function removeOldVotes() {
            if (!confirm('Удалить голосы старше 30 дней?')) {
                return;
            }
            
            showSpinner('Удаление старых голосов...');
            
            try {
                const monthAgo = new Date(Date.now() - 30 * 86400000);
                const oldVotes = allVotes.filter(v => new Date(v.timestamp) < monthAgo);
                
                if (oldVotes.length === 0) {
                    showNotification('info', 'Удаление старых голосов', 'Старых голосов не найдено');
                    return;
                }
                
                // Удаляем из Firebase
                for (const vote of oldVotes) {
                    await deleteVoteFromFirebase(vote.id);
                }
                
                // Обновляем локальные данные
                allVotes = allVotes.filter(v => !oldVotes.some(ov => ov.id === v.id));
                filteredVotes = filteredVotes.filter(v => !oldVotes.some(ov => ov.id === v.id));
                
                // Обновляем интерфейс
                updateDashboardStats(allVotes);
                updateVotesTable(filteredVotes);
                
                showNotification('success', 'Удаление старых голосов', 
                    `Удалено ${oldVotes.length} голосов старше 30 дней`);
                
            } catch (error) {
                console.error('Ошибка удаления старых голосов:', error);
                showNotification('error', 'Ошибка удаления', 'Не удалось удалить старые голоса');
            } finally {
                hideSpinner();
            }
        }
        
        function showResetModal() {
            showConfirmationModal(
                'Сброс всех данных',
                `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>ВНИМАНИЕ!</strong> Вы собираетесь удалить ВСЕ данные голосования.
                    Это действие необратимо!
                </div>
                <div class="mb-3">
                    <label class="form-label">Введите пароль для подтверждения:</label>
                    <input type="password" class="form-control" id="resetPassword" placeholder="Пароль администратора">
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmReset">
                    <label class="form-check-label" for="confirmReset">
                        Я понимаю, что все данные будут удалены без возможности восстановления
                    </label>
                </div>
                `,
                'Сбросить всё',
                async () => {
                    const password = document.getElementById('resetPassword').value;
                    const confirmed = document.getElementById('confirmReset').checked;
                    
                    if (!confirmed) {
                        showNotification('error', 'Ошибка', 'Подтвердите понимание последствий');
                        return;
                    }
                    
                    if (password !== ADMIN_CONFIG.password) {
                        showNotification('error', 'Ошибка', 'Неверный пароль');
                        return;
                    }
                    
                    await resetAllData();
                },
                true
            );
        }
        
        async function resetAllData() {
            if (!confirm('ВНИМАНИЕ! Это удалит ВСЕ данные без возможности восстановления. Продолжить?')) {
                return;
            }
            
            showSpinner('Сброс всех данных...');
            
            try {
                // Очищаем Firebase
                await clearAllVotesFromFirebase();
                
                // Очищаем локальные данные
                allVotes = [];
                filteredVotes = [];
                
                // Обновляем интерфейс
                updateDashboardStats(allVotes);
                updateVotesTable(filteredVotes);
                updateNotifications();
                
                showNotification('success', 'Сброс данных', 'Все данные успешно сброшены');
                
            } catch (error) {
                console.error('Ошибка сброса данных:', error);
                showNotification('error', 'Ошибка сброса', 'Не удалось сбросить данные');
            } finally {
                hideSpinner();
            }
        }

        // ==================== НАСТРОЙКИ ====================
        function saveSettings() {
            const newDistrict = document.getElementById('districtNameInput').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const enableNotifications = document.getElementById('enableNotifications').checked;
            
            let changes = [];
            
            // Обновление названия района
            if (newDistrict && newDistrict !== ADMIN_CONFIG.defaultDistrict) {
                ADMIN_CONFIG.defaultDistrict = newDistrict;
                changes.push('название района');
                
                // Обновляем отображение
                document.querySelectorAll('.district-name').forEach(el => {
                    el.textContent = newDistrict;
                });
            }
            
            // Обновление пароля
            if (newPassword) {
                if (newPassword === confirmPassword) {
                    ADMIN_CONFIG.password = newPassword;
                    changes.push('пароль администратора');
                    
                    // Очищаем поля пароля
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    
                    showNotification('info', 'Пароль изменён', `Новый пароль: ${newPassword}`);
                } else {
                    showNotification('error', 'Ошибка', 'Пароли не совпадают');
                    return;
                }
            }
            
            // Настройка уведомлений
            localStorage.setItem('adminNotifications', enableNotifications ? 'enabled' : 'disabled');
            
            if (enableNotifications) {
                changes.push('уведомления включены');
            } else {
                changes.push('уведомления отключены');
            }
            
            if (changes.length > 0) {
                showNotification('success', 'Настройки сохранены', 
                    `Изменения: ${changes.join(', ')}`);
            } else {
                showNotification('info', 'Настройки', 'Изменений нет');
            }
        }

        // ==================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================
        function refreshDashboard() {
            showNotification('info', 'Обновление', 'Загрузка обновлённых данных...');
            loadAdminData();
        }
        
        function showHelp() {
            showConfirmationModal(
                'Справка по админ-панели',
                `
                <h5>Основные функции:</h5>
                <ul>
                    <li><strong>Управление голосами:</strong> Просмотр, фильтрация и удаление голосов</li>
                    <li><strong>Экспорт данных:</strong> Экспорт в JSON, CSV, PDF, Excel форматах</li>
                    <li><strong>Импорт данных:</strong> Загрузка данных из JSON/CSV файлов</li>
                    <li><strong>Быстрые операции:</strong> Очистка БД, резервное копирование</li>
                    <li><strong>Опасные операции:</strong> Удаление дубликатов, старых голосов, полный сброс</li>
                </ul>
                <h5>Советы:</h5>
                <ul>
                    <li>Регулярно создавайте резервные копии данных</li>
                    <li>Измените пароль по умолчанию</li>
                    <li>Перед опасными операциями экспортируйте данные</li>
                    <li>Для массового сбора данных используйте импорт</li>
                </ul>
                `,
                'Закрыть',
                () => {}
            );
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('ru-RU');
        }
        
        function updateNotifications() {
            // Простая логика уведомлений
            const todayVotes = allVotes.filter(v => {
                const today = new Date().toDateString();
                return new Date(v.timestamp).toDateString() === today;
            }).length;
            
            if (todayVotes > 0) {
                document.getElementById('notificationBadge').textContent = todayVotes;
                document.getElementById('notificationBadge').style.display = 'flex';
            } else {
                document.getElementById('notificationBadge').style.display = 'none';
            }
        }
        
        function showNotification(type, title, message) {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';
            
            const icon = {
                'success': 'check-circle',
                'error': 'exclamation-triangle',
                'info': 'info-circle',
                'warning': 'exclamation-circle'
            }[type] || 'info-circle';
            
            // Удаляем старые уведомления
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification alert ${alertClass} alert-dismissible fade show`;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${icon} fa-lg me-3"></i>
                    <div>
                        <h6 class="mb-1">${title}</h6>
                        <p class="mb-0 small">${message}</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function showSpinner(message = 'Загрузка...') {
            // Удаляем старый спиннер
            const oldSpinner = document.getElementById('spinnerOverlay');
            if (oldSpinner) oldSpinner.remove();
            
            const spinner = document.createElement('div');
            spinner.id = 'spinnerOverlay';
            spinner.className = 'spinner-overlay';
            spinner.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3 text-white">${message}</p>
                </div>
            `;
            
            document.body.appendChild(spinner);
        }
        
        function hideSpinner() {
            const spinner = document.getElementById('spinnerOverlay');
            if (spinner) spinner.remove();
        }
        
        function showConfirmationModal(title, content, confirmText, onConfirm, showCancel = true) {
            // Удаляем старые модальные окна
            const oldModal = document.getElementById('confirmationModal');
            if (oldModal) oldModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'confirmationModal';
            modal.className = 'confirmation-modal';
            modal.innerHTML = `
                <div class="confirmation-content">
                    <h5 class="mb-3">${title}</h5>
                    <div class="mb-4">${content}</div>
                    <div class="d-flex justify-content-end gap-2">
                        ${showCancel ? `<button class="btn btn-secondary" onclick="document.getElementById('confirmationModal').remove()">Отмена</button>` : ''}
                        <button class="btn btn-primary" onclick="
                            const modal = document.getElementById('confirmationModal');
                            modal.remove();
                            (${onConfirm.toString()})();
                        ">${confirmText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('[onclick="toggleDarkMode()"] i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
            
            // Сохраняем настройку
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        }

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Настройка показа пароля
            document.getElementById('showPassword').addEventListener('change', function() {
                const passwordField = document.getElementById('adminPassword');
                passwordField.type = this.checked ? 'text' : 'password';
            });
            
            // Настройка выбора периода экспорта
            document.getElementById('exportPeriod').addEventListener('change', function() {
                const customDates = document.getElementById('customDates');
                customDates.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            // Drag and drop для импорта
            const dropZone = document.getElementById('dropZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropZone.style.borderColor = '#3498db';
                dropZone.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            }
            
            function unhighlight() {
                dropZone.style.borderColor = '#dee2e6';
                dropZone.style.backgroundColor = '';
            }
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                filesToImport = Array.from(files);
                updateFileInfo();
            }
            
            // Загружаем настройки темы
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                const icon = document.querySelector('[onclick="toggleDarkMode()"] i');
                if (icon) icon.className = 'fas fa-sun';
            }
            
            // Автоматический вход по URL параметру
            const urlParams = new URLSearchParams(window.location.search);
            const passwordParam = urlParams.get('password');
            
            if (passwordParam === ADMIN_CONFIG.password) {
                document.getElementById('adminPassword').value = ADMIN_CONFIG.password;
                setTimeout(login, 500);
            }
        });
    </script>
</body>
</html>
