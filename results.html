<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞ - –ó–∞–¥–Ω–µ–ø—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
        .container { max-width: 800px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-chart-bar"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞
            </span>
            <a href="index.html" class="btn btn-light">
                <i class="fas fa-vote-yea"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞ –ñ–ö–•</h1>
        <h3 class="text-center text-muted">–ó–∞–¥–Ω–µ–ø—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω</h3>
        
        <div class="text-center mt-4">
            <div class="spinner-border text-primary" id="spinner"></div>
            <p id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
        
        <div id="results" style="display: none;">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ===
        // ‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ü–†–ê–í–ò–õ–¨–ù–´–ô URL!
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA9x1ZcFgHjklmnoiT2XqPq3RzABCDEFGH",
            authDomain: "poll-hope-11.firebaseapp.com",
            // –ü–†–ê–í–ò–õ–¨–ù–´–ô URL –¥–ª—è europe-west1 —Ä–µ–≥–∏–æ–Ω–∞:
            databaseURL: "https://poll-hope-11-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "poll-hope-11",
            storageBucket: "poll-hope-11.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };
        
        // === –§–£–ù–ö–¶–ò–ò ===
        
        async function initializeApp() {
            try {
                updateStatus("–ó–∞–≥—Ä—É–∑–∫–∞ Firebase...");
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Firebase SDK
                await loadScript("https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js");
                await loadScript("https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js");
                
                updateStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...");
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
                firebase.initializeApp(FIREBASE_CONFIG);
                
                updateStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...");
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await loadVotes();
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                updateStatus("–û—à–∏–±–∫–∞: " + error.message, true);
                showError(error);
            }
        }
        
        async function loadVotes() {
            try {
                const db = firebase.database();
                
                updateStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤...");
                
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                const snapshot = await db.ref('votes').once('value');
                const data = snapshot.val();
                
                if (data) {
                    const votes = Object.values(data);
                    updateStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${votes.length} –≥–æ–ª–æ—Å–æ–≤`, false);
                    showResults(votes);
                } else {
                    updateStatus("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ", false);
                    showNoData();
                }
                
            } catch (error) {
                throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: " + error.message);
            }
        }
        
        function showResults(votes) {
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            document.getElementById('spinner').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            let html = `
                <div class="alert alert-success">
                    <h4>‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!</h4>
                    <p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤: <strong>${votes.length}</strong></p>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                                <p>–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤: ${votes.length}</p>
                                <p>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤: ${countUniqueAddresses(votes)}</p>
                                <p>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${calculateAverageRating(votes).toFixed(1)}/5.0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–ª–æ—Å–∞</h5>
                                ${getRecentVotes(votes)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('results').innerHTML = html;
            document.getElementById('results').style.display = 'block';
        }
        
        function showNoData() {
            document.getElementById('spinner').style.display = 'none';
            
            document.getElementById('results').innerHTML = `
                <div class="alert alert-info mt-4">
                    <h5>üì≠ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞</h5>
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                    <a href="index.html" class="btn btn-primary">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</a>
                </div>
            `;
            document.getElementById('results').style.display = 'block';
        }
        
        function showError(error) {
            document.getElementById('spinner').style.display = 'none';
            
            let errorMessage = error.message;
            let solution = "";
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
            if (errorMessage.includes("CERT_COMMON_NAME_INVALID")) {
                solution = `
                    <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞ europe-west1:</p>
                    <code>databaseURL: "https://poll-hope-11-default-rtdb.europe-west1.firebasedatabase.app"</code>
                `;
            } else if (errorMessage.includes("permission_denied")) {
                solution = `<p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –í Firebase Console –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Rules –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:<br>
                    <code>{ "rules": { ".read": true, ".write": true } }</code></p>`;
            }
            
            document.getElementById('results').innerHTML = `
                <div class="alert alert-danger mt-4">
                    <h5>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h5>
                    <p>${errorMessage}</p>
                    ${solution}
                    <hr>
                    <p>–¢–µ–∫—É—â–∏–π databaseURL: <code>${FIREBASE_CONFIG.databaseURL}</code></p>
                    <button class="btn btn-warning mt-2" onclick="testDifferentURLs()">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ URL</button>
                </div>
            `;
            document.getElementById('results').style.display = 'block';
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function countUniqueAddresses(votes) {
            const addresses = new Set();
            votes.forEach(v => {
                if (v.street && v.house) {
                    addresses.add(v.street + ', ' + v.house);
                }
            });
            return addresses.size;
        }
        
        function calculateAverageRating(votes) {
            if (votes.length === 0) return 0;
            
            let total = 0;
            let count = 0;
            
            votes.forEach(vote => {
                if (vote.answers && Array.isArray(vote.answers)) {
                    vote.answers.forEach(answer => {
                        const value = parseInt(answer.value);
                        if (!isNaN(value)) {
                            total += value;
                            count++;
                        }
                    });
                }
            });
            
            return count > 0 ? total / count : 0;
        }
        
        function getRecentVotes(votes) {
            const recent = votes
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            if (recent.length === 0) return "<p>–ù–µ—Ç –≥–æ–ª–æ—Å–æ–≤</p>";
            
            return recent.map(v => `
                <div class="border-bottom py-2">
                    <small>${new Date(v.timestamp).toLocaleTimeString('ru-RU')}</small><br>
                    <strong>${v.street}, ${v.house}</strong>
                </div>
            `).join('');
        }
        
        function updateStatus(message, showSpinner = true) {
            document.getElementById('status').textContent = message;
            document.getElementById('spinner').style.display = showSpinner ? 'block' : 'none';
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö URL
        function testDifferentURLs() {
            const urls = [
                "https://poll-hope-11-default-rtdb.firebaseio.com",
                "https://poll-hope-11-default-rtdb.firebaseio.com/",
                "https://poll-hope-11-default-rtdb.europe-west1.firebasedatabase.app",
                "https://poll-hope-11-default-rtdb.europe-west1.firebasedatabase.app/"
            ];
            
            let testResults = "<h6>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h6>";
            
            urls.forEach(url => {
                testResults += `<div class="mb-2"><code>${url}</code> - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>`;
            });
            
            document.getElementById('results').innerHTML += `
                <div class="mt-4">
                    ${testResults}
                    <p class="text-muted">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</p>
                </div>
            `;
            
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ URL
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
