<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .card { margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞ –ñ–ö–•</h1>
        <p class="text-center text-muted">–ó–∞–¥–Ω–µ–ø—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω</p>
        
        <div class="text-center mb-4">
            <a href="index.html" class="btn btn-primary">‚Üê –ù–∞–∑–∞–¥ –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é</a>
            <button class="btn btn-success" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div id="results">
            <div class="text-center">
                <div class="spinner-border text-primary"></div>
                <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
        </div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ===
        // ‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ firebasedatabase.app –¥–ª—è europe-west1
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA9x1ZcFgHjklmnoiT2XqPq3RzABCDEFGH",
            authDomain: "poll-hope-11.firebaseapp.com",
            // ‚ö†Ô∏è –ü–†–ê–í–ò–õ–¨–ù–´–ô URL –¥–ª—è –ß–¢–ï–ù–ò–Ø:
            databaseURL: "https://poll-hope-11-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "poll-hope-11",
            storageBucket: "poll-hope-11.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };
        
        // === –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –°–ü–û–°–û–ë –ß–¢–ï–ù–ò–Ø (—á–µ—Ä–µ–∑ REST API) ===
        async function loadDataViaRestAPI() {
            try {
                const databaseURL = "https://poll-hope-11-default-rtdb.europe-west1.firebasedatabase.app";
                const response = await fetch(`${databaseURL}/votes.json`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                return data ? Object.values(data) : [];
                
            } catch (error) {
                console.error("REST API error:", error);
                throw error;
            }
        }
        
        // === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò ===
        async function loadData() {
            try {
                document.getElementById('results').innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </div>
                `;
                
                let votes = [];
                
                // –ü—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ —á–µ—Ä–µ–∑ REST API (–æ–±—Ö–æ–¥–∏—Ç SSL –ø—Ä–æ–±–ª–µ–º—ã)
                try {
                    console.log("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ REST API...");
                    votes = await loadDataViaRestAPI();
                    console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ REST API:", votes.length);
                    
                } catch (restError) {
                    console.log("REST API –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º Firebase SDK...");
                    
                    // –ï—Å–ª–∏ REST –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ Firebase SDK
                    votes = await loadDataViaFirebaseSDK();
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (votes.length === 0) {
                    showNoData();
                } else {
                    showResults(votes);
                }
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                showError(error);
            }
        }
        
        async function loadDataViaFirebaseSDK() {
            return new Promise((resolve, reject) => {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Firebase SDK –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (typeof firebase === 'undefined') {
                    const script1 = document.createElement('script');
                    script1.src = "https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js";
                    
                    script1.onload = () => {
                        const script2 = document.createElement('script');
                        script2.src = "https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js";
                        
                        script2.onload = () => {
                            initializeAndLoad(resolve, reject);
                        };
                        
                        script2.onerror = () => reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Firebase Database"));
                        document.head.appendChild(script2);
                    };
                    
                    script1.onerror = () => reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Firebase App"));
                    document.head.appendChild(script1);
                } else {
                    initializeAndLoad(resolve, reject);
                }
            });
        }
        
        function initializeAndLoad(resolve, reject) {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
                const app = firebase.initializeApp(FIREBASE_CONFIG);
                const db = firebase.database();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                db.ref('votes').once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        resolve(data ? Object.values(data) : []);
                    })
                    .catch(reject);
                    
            } catch (error) {
                reject(error);
            }
        }
        
        // === –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ===
        function showResults(votes) {
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const totalVotes = votes.length;
            
            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞
            const addresses = new Set();
            votes.forEach(v => {
                if (v.street && v.house) {
                    addresses.add(`${v.street}, ${v.house}`);
                }
            });
            
            // –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
            let totalRating = 0;
            let ratingCount = 0;
            
            votes.forEach(vote => {
                if (vote.answers && Array.isArray(vote.answers)) {
                    vote.answers.forEach(answer => {
                        const value = parseInt(answer.value);
                        if (!isNaN(value)) {
                            totalRating += value;
                            ratingCount++;
                        }
                    });
                }
            });
            
            const avgRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : "0.0";
            
            // HTML
            let html = `
                <div class="alert alert-success">
                    <h4><i class="fas fa-check-circle"></i> –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!</h4>
                    <p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ <strong>${totalVotes}</strong> –≥–æ–ª–æ—Å–æ–≤ –∏–∑ –æ–±–ª–∞—á–Ω–æ–π –±–∞–∑—ã</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h2 class="mb-0">${totalVotes}</h2>
                                <p class="mb-0">–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h2 class="mb-0">${addresses.size}</h2>
                                <p class="mb-0">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h2 class="mb-0">${avgRating}</h2>
                                <p class="mb-0">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h2 class="mb-0">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</h2>
                                <p class="mb-0">–û–±–Ω–æ–≤–ª–µ–Ω–æ</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–ª–æ—Å–∞:</h4>
                <div class="list-group mb-4">
            `;
            
            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–ª–æ—Å–∞
            const recentVotes = votes
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 15);
            
            recentVotes.forEach(vote => {
                const time = new Date(vote.timestamp).toLocaleTimeString('ru-RU');
                const date = new Date(vote.timestamp).toLocaleDateString('ru-RU');
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-home"></i> ${vote.street}, ${vote.house}</h6>
                            <small>${date} ${time}</small>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">–û—Ç–≤–µ—Ç—ã:</small>
                            <div class="d-flex gap-2">
                `;
                
                if (vote.answers && Array.isArray(vote.answers)) {
                    vote.answers.forEach((answer, idx) => {
                        const value = parseInt(answer.value);
                        let color = "danger";
                        if (value >= 4) color = "success";
                        else if (value >= 3) color = "warning";
                        
                        html += `<span class="badge bg-${color}">${value}</span>`;
                    });
                }
                
                if (vote.comment) {
                    html += `</div><p class="mt-2 mb-1"><small>üí¨ ${vote.comment}</small></p>`;
                }
                
                html += `</div></div>`;
            });
            
            html += `</div>`;
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–ª–∏—Ü–∞–º
            const streetStats = {};
            votes.forEach(v => {
                if (v.street) {
                    streetStats[v.street] = (streetStats[v.street] || 0) + 1;
                }
            });
            
            if (Object.keys(streetStats).length > 0) {
                html += `<h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–ª–∏—Ü–∞–º:</h4><ul class="list-group">`;
                
                Object.entries(streetStats)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([street, count]) => {
                        html += `
                            <li class="list-group-item d-flex justify-content-between">
                                <span>${street}</span>
                                <span class="badge bg-primary">${count}</span>
                            </li>
                        `;
                    });
                
                html += `</ul>`;
            }
            
            document.getElementById('results').innerHTML = html;
        }
        
        function showNoData() {
            document.getElementById('results').innerHTML = `
                <div class="alert alert-info text-center">
                    <h4><i class="fas fa-database"></i> –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞</h4>
                    <p class="mb-3">–í –æ–±–ª–∞—á–Ω–æ–π –±–∞–∑–µ –ø–æ–∫–∞ –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤.</p>
                    <a href="index.html" class="btn btn-primary">–°—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º</a>
                </div>
            `;
        }
        
        function showError(error) {
            let errorHtml = `
                <div class="alert alert-danger">
                    <h4><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
                    <p>${error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}</p>
                    
                    <h5 class="mt-3">–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:</h5>
                    <ol>
                        <li><strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:</strong><br>
                            <code>${FIREBASE_CONFIG.databaseURL}</code></li>
                        <li><strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ Firebase Console:</strong><br>
                            –ü—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å: <code>{ "rules": { ".read": true, ".write": true } }</code></li>
                        <li><strong>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä</strong> –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏ —Ä–µ–∫–ª–∞–º—ã</li>
                    </ol>
                    
                    <div class="mt-3">
                        <button class="btn btn-warning" onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                        <button class="btn btn-secondary" onclick="location.reload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                    </div>
                </div>
            `;
            
            document.getElementById('results').innerHTML = errorHtml;
        }
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testConnection() {
            try {
                const testUrl = FIREBASE_CONFIG.databaseURL.replace('firebasedatabase.app', 'firebaseio.com') + '/.json';
                const response = await fetch(testUrl);
                
                if (response.ok) {
                    alert("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç!");
                } else {
                    alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.");
                }
            } catch (error) {
                alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase.");
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        document.addEventListener('DOMContentLoaded', loadData);
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            const isVisible = document.visibilityState === 'visible';
            if (isVisible) {
                loadData();
            }
        }, 30000);
    </script>
    
    <!-- –ò–∫–æ–Ω–∫–∏ FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
</body>
</html>
