<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опрос ЖКХ - Заднепровский район (Королевка)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .star { color: #ddd; font-size: 30px; cursor: pointer; margin: 0 5px; }
        .star.active { color: #ffc107; }
        .question { background: white; padding: 20px; border-radius: 10px; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .address-select { background-color: #f0f8ff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-home"></i> Опрос ЖКХ
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="text-center mb-4">
            <h1 class="text-primary">Опрос качества ЖКХ</h1>
            <h3 class="text-muted">Заднепровский район, мкр. Королевка</h3>
            
            <div class="alert alert-info d-inline-block mt-3">
                <i class="fas fa-users"></i> Всего голосов: <span id="totalVotes">0</span>
            </div>
        </div>

        <!-- Обращение к жителям -->
        <div class="card mb-4 bg-light">
            <div class="card-body">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="fas fa-bullhorn text-primary fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="card-title text-primary">Уважаемые жители микрорайона Королевка!</h5>
                        <p class="card-text" style="font-size: 1.05rem; line-height: 1.5;">
                            В целях улучшения качества жилищно-коммунальных услуг, предоставляемых УК "Мой Смоленск", просим Вас ответить на несколько вопросов.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Адрес - выпадающий список -->
        <div class="card mb-4 address-select">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-map-marker-alt text-danger"></i> Выберите ваш адрес</h5>
                <div class="row g-3">
                    <div class="col-md-12">
                        <select class="form-select form-select-lg" id="addressSelect" required>
                            <option value="" selected disabled>-- Выберите адрес из списка --</option>
                            <option value="г. Смоленск, ул. Ударников, д. 36">г. Смоленск, ул. Ударников, д. 36</option>
                            <option value="г. Смоленск, ул. Авиаторов, д. 5Б">г. Смоленск, ул. Авиаторов, д. 5Б</option>
                            <option value="г. Смоленск, ул. Авиаторов, д. 9">г. Смоленск, ул. Авиаторов, д. 9</option>
                            <option value="г. Смоленск, мкр. Королевка, д. 13a">г. Смоленск, мкр. Королевка, д. 13a</option>
                            <option value="г. Смоленск, ул. Авиаторов, д. 4">г. Смоленск, ул. Авиаторов, д. 4</option>
                            <option value="г. Смоленск, ул. Маршала Еременко, д. 32">г. Смоленск, ул. Маршала Еременко, д. 32</option>
                            <option value="г. Смоленск, мкр. Королевка, д. 20">г. Смоленск, мкр. Королевка, д. 20</option>
                        </select>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Если вашего адреса нет в списке, обратитесь в управляющую компанию
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="entrance" placeholder="Подъезд (необязательно)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Вопросы -->
        <div id="questionsContainer"></div>

        <!-- Кнопки -->
        <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary btn-lg" onclick="submitVote()">
                <i class="fas fa-paper-plane"></i> Отправить голос
            </button>
            <a href="results.html" class="btn btn-success btn-lg">
                <i class="fas fa-chart-bar"></i> Посмотреть результаты
            </a>
        </div>

        <div class="alert alert-warning mt-4">
            <i class="fas fa-info-circle"></i> Все голоса автоматически синхронизируются между всеми участниками.
        </div>
    </div>

    <!-- Модальное окно успеха -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check-circle"></i> Спасибо за участие!</h5>
                </div>
                <div class="modal-body">
                    <p>Ваш голос сохранен и отправлен в общую базу!</p>
                    <p>Все участники увидят обновленные результаты.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <a href="results.html" class="btn btn-primary">Посмотреть результаты</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Конфигурация Firebase 
        const firebaseConfig = {
            apiKey: "AIzaSyC2vT8VZ79PC7wN92xQb7ZMAbhHEf2NeGQ",
            authDomain: "zhkh-123sm.firebaseapp.com",
            databaseURL: "https://zhkh-123sm-default-rtdb.firebaseio.com",
            projectId: "zhkh-123sm",
            storageBucket: "zhkh-123sm.firebasestorage.app",
            messagingSenderId: "199139893208",
            appId: "1:199139893208:web:8a41fa28faa05fdedc996a",
            measurementId: "G-9E832Q6LBL"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Массив вопросов
        const questions = [
            { id: 1, text: "Уборка внутри подъезда" },
            { id: 2, text: "Освещение внутри подъезда" },
            { id: 3, text: "Работа лифта" },
            { id: 4, text: "Уборка снега с тротуаров и проезжих частей" },
            { id: 5, text: "Уличное освещение во дворе" },
            { id: 6, text: "Вывоз мусора" }
        ];

        // Хранилище оценок
        let ratings = {};

        // Загрузка вопросов
        function loadQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach(q => {
                ratings[q.id] = 0;
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <h5>${q.text}</h5>
                    <div class="rating-stars" data-question-id="${q.id}">
                        ${generateStars(0, q.id)}
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            attachStarEvents();
            loadTotalVotes();
        }

        // Генерация звезд
        function generateStars(rating, questionId) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="star ${i <= rating ? 'active' : ''}" data-value="${i}" data-question="${questionId}">★</span>`;
            }
            return stars;
        }

        // Обработчики кликов на звезды
        function attachStarEvents() {
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function(e) {
                    const value = parseInt(this.dataset.value);
                    const questionId = parseInt(this.dataset.question);
                    
                    ratings[questionId] = value;
                    
                    const starsContainer = this.closest('.rating-stars');
                    starsContainer.innerHTML = generateStars(value, questionId);
                    
                    attachStarEvents();
                });
            });
        }

        // Загрузка общего количества голосов
        function loadTotalVotes() {
            const votesRef = database.ref('votes');
            votesRef.once('value', (snapshot) => {
                const votes = snapshot.val();
                const count = votes ? Object.keys(votes).length : 0;
                document.getElementById('totalVotes').textContent = count;
            });
        }

        // Отправка голоса в Firebase
        async function submitVote() {
            const addressSelect = document.getElementById('addressSelect');
            const selectedAddress = addressSelect.value;
            const entrance = document.getElementById('entrance').value;
            
            if (!selectedAddress) {
                alert('Пожалуйста, выберите ваш адрес из списка');
                addressSelect.focus();
                return;
            }
            
            let allRated = true;
            questions.forEach(q => {
                if (ratings[q.id] === 0) allRated = false;
            });
            
            if (!allRated) {
                alert('Пожалуйста, оцените все услуги');
                return;
            }
            
            try {
                // Показываем состояние загрузки
                const submitBtn = document.querySelector('button[onclick="submitVote()"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
                
                // Создаем новый голос в Firebase
                const votesRef = database.ref('votes');
                const newVoteRef = votesRef.push();
                
                await newVoteRef.set({
                    address: selectedAddress,
                    entrance: entrance || null,
                    ratings: ratings,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    date: new Date().toISOString()
                });
                
                // Обновляем общую статистику
                await updateOverallStats(ratings);
                
                // Обновляем статистику по адресу
                await updateAddressStats(selectedAddress, ratings);
                
                // Обновляем счетчик
                await loadTotalVotes();
                
                // Показываем модальное окно успеха
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();
                
                // Очищаем форму
                clearForm();
                
            } catch (error) {
                console.error('Ошибка при сохранении в Firebase:', error);
                alert('Произошла ошибка при отправке голоса. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Возвращаем кнопку в исходное состояние
                const submitBtn = document.querySelector('button[onclick="submitVote()"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить голос';
            }
        }

        // Обновление общей статистики
        async function updateOverallStats(ratings) {
            const statsRef = database.ref('statistics/overall');
            
            try {
                const snapshot = await statsRef.once('value');
                let stats = snapshot.val();
                
                if (!stats) {
                    // Инициализируем статистику если её нет
                    stats = {
                        totalVotes: 0,
                        questions: {}
                    };
                    questions.forEach(q => {
                        stats.questions[q.id] = {
                            total: 0,
                            count: 0,
                            average: 0
                        };
                    });
                }
                
                // Обновляем статистику
                stats.totalVotes = (stats.totalVotes || 0) + 1;
                
                questions.forEach(q => {
                    if (!stats.questions[q.id]) {
                        stats.questions[q.id] = { total: 0, count: 0, average: 0 };
                    }
                    stats.questions[q.id].total += ratings[q.id];
                    stats.questions[q.id].count += 1;
                    stats.questions[q.id].average = 
                        stats.questions[q.id].total / stats.questions[q.id].count;
                });
                
                await statsRef.set(stats);
                
            } catch (error) {
                console.error('Ошибка обновления статистики:', error);
                throw error;
            }
        }

        // Обновление статистики по адресу
        async function updateAddressStats(address, ratings) {
            const addressStatsRef = database.ref(`statistics/addresses/${encodeURIComponent(address)}`);
            
            try {
                const snapshot = await addressStatsRef.once('value');
                let stats = snapshot.val();
                
                if (!stats) {
                    stats = {
                        totalVotes: 0,
                        questions: {}
                    };
                    questions.forEach(q => {
                        stats.questions[q.id] = {
                            total: 0,
                            count: 0,
                            average: 0
                        };
                    });
                }
                
                stats.totalVotes = (stats.totalVotes || 0) + 1;
                
                questions.forEach(q => {
                    if (!stats.questions[q.id]) {
                        stats.questions[q.id] = { total: 0, count: 0, average: 0 };
                    }
                    stats.questions[q.id].total += ratings[q.id];
                    stats.questions[q.id].count += 1;
                    stats.questions[q.id].average = 
                        stats.questions[q.id].total / stats.questions[q.id].count;
                });
                
                await addressStatsRef.set(stats);
                
            } catch (error) {
                console.error('Ошибка обновления статистики адреса:', error);
                throw error;
            }
        }

        // Очистка формы
        function clearForm() {
            document.getElementById('addressSelect').value = '';
            document.getElementById('entrance').value = '';
            
            questions.forEach(q => {
                ratings[q.id] = 0;
            });
            
            loadQuestions();
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestions();
        });

        // Делаем функции глобальными
        window.submitVote = submitVote;
    </script>
</body>
</html>
