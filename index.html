<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опрос ЖКХ - Заднепровский район (Королевка)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .star { color: #ddd; font-size: 30px; cursor: pointer; margin: 0 5px; }
        .star.active { color: #ffc107; }
        .question { background: white; padding: 20px; border-radius: 10px; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .address-select { background-color: #f0f8ff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-home"></i> Опрос ЖКХ
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="text-center mb-4">
            <h1 class="text-primary">Опрос качества ЖКХ</h1>
            <h3 class="text-muted">Заднепровский район, мкр. Королевка</h3>
            
            <div class="alert alert-info d-inline-block mt-3">
                <i class="fas fa-users"></i> Всего голосов: <span id="totalVotes">0</span>
            </div>
        </div>

        <!-- Обращение к жителям -->
        <div class="card mb-4 bg-light">
            <div class="card-body">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="fas fa-bullhorn text-primary fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="card-title text-primary">Уважаемые жители микрорайона Королевка!</h5>
                        <p class="card-text" style="font-size: 1.05rem; line-height: 1.5;">
                            В целях улучшения качества жилищно-коммунальных услуг, предоставляемых УК "Мой Смоленск", просим Вас ответить на несколько вопросов.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Адрес - выпадающий список -->
        <div class="card mb-4 address-select">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-map-marker-alt text-danger"></i> Выберите ваш адрес</h5>
                <div class="row g-3">
                    <div class="col-md-12">
                        <select class="form-select form-select-lg" id="addressSelect" required>
                            <option value="" selected disabled>-- Выберите адрес из списка --</option>
                            <option value="г. Смоленск, ул. Ударников, д. 36">г. Смоленск, ул. Ударников, д. 36</option>
                            <option value="г. Смоленск, ул. Авиаторов, д. 5Б">г. Смоленск, ул. Авиаторов, д. 5Б</option>
                            <option value="г. Смоленск, ул. Авиаторов, д. 9">г. Смоленск, ул. Авиаторов, д. 9</option>
                            <option value="г. Смоленск, мкр. Королевка, д. 13a">г. Смоленск, мкр. Королевка, д. 13a</option>
                            <option value="г. Смоленск, ул. Авиаторов, д. 4">г. Смоленск, ул. Авиаторов, д. 4</option>
                            <option value="г. Смоленск, ул. Маршала Еременко, д. 32">г. Смоленск, ул. Маршала Еременко, д. 32</option>
                            <option value="г. Смоленск, мкр. Королевка, д. 20">г. Смоленск, мкр. Королевка, д. 20</option>
                        </select>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Если вашего адреса нет в списке, обратитесь в управляющую компанию
                        </div>
                    </div>
                </div>
                <!-- Дополнительное поле для номера подъезда -->
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="entrance" placeholder="Подъезд (необязательно)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Вопросы (оценка по 5-звездочной шкале) -->
        <div id="questionsContainer">
            <!-- Вопросы будут загружены через app.js -->
        </div>

        <!-- Кнопки -->
        <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary btn-lg" onclick="submitVote()">
                <i class="fas fa-paper-plane"></i> Отправить голос
            </button>
            <a href="results.html" class="btn btn-success btn-lg">
                <i class="fas fa-chart-bar"></i> Посмотреть результаты
            </a>
        </div>

        <div class="alert alert-warning mt-4">
            <i class="fas fa-info-circle"></i> Все голоса автоматически синхронизируются между всеми участниками.
        </div>
    </div>

    <!-- Модальное окно успеха -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check-circle"></i> Спасибо за участие!</h5>
                </div>
                <div class="modal-body">
                    <p>Ваш голос сохранен и отправлен в общую базу!</p>
                    <p>Все участники увидят обновленные результаты.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <a href="results.html" class="btn btn-primary">Посмотреть результаты</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Скрипт с вопросами и логикой -->
    <script>
        // Массив вопросов
        const questions = [
            { id: 1, text: "Уборка внутри подъезда" },
            { id: 2, text: "Освещение внутри подъезда" },
            { id: 3, text: "Работа лифта" },
            { id: 4, text: "Уборка снега с тротуаров и проезжих частей" },
            { id: 5, text: "Уличное освещение во дворе" },
            { id: 6, text: "Вывоз мусора" }
        ];

        // Список адресов для отображения в результатах
        const addressList = [
            "г. Смоленск, ул. Ударников, д. 36",
            "г. Смоленск, ул. Авиаторов, д. 5Б",
            "г. Смоленск, ул. Авиаторов, д. 9",
            "г. Смоленск, мкр. Королевка, д. 13a",
            "г. Смоленск, ул. Авиаторов, д. 4",
            "г. Смоленск, ул. Маршала Еременко, д. 32",
            "г. Смоленск, мкр. Королевка, д. 20"
        ];

        // Хранилище оценок
        let ratings = {};

        // Загрузка вопросов
        function loadQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach(q => {
                ratings[q.id] = 0;
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <h5>${q.text}</h5>
                    <div class="rating-stars" data-question-id="${q.id}">
                        ${generateStars(0, q.id)}
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            // Добавляем обработчики событий после создания звезд
            attachStarEvents();
        }

        // Генерация звезд
        function generateStars(rating, questionId) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="star ${i <= rating ? 'active' : ''}" data-value="${i}" data-question="${questionId}">★</span>`;
            }
            return stars;
        }

        // Обработчики кликов на звезды
        function attachStarEvents() {
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function(e) {
                    const value = parseInt(this.dataset.value);
                    const questionId = parseInt(this.dataset.question);
                    
                    // Обновляем оценку в хранилище
                    ratings[questionId] = value;
                    
                    // Обновляем отображение звезд
                    const starsContainer = this.closest('.rating-stars');
                    starsContainer.innerHTML = generateStars(value, questionId);
                    
                    // Перепривязываем события
                    attachStarEvents();
                });
            });
        }

        // Отправка голоса
        function submitVote() {
            const addressSelect = document.getElementById('addressSelect');
            const selectedAddress = addressSelect.value;
            const entrance = document.getElementById('entrance').value;
            
            if (!selectedAddress) {
                alert('Пожалуйста, выберите ваш адрес из списка');
                addressSelect.focus();
                return;
            }
            
            // Проверяем, все ли вопросы оценены
            let allRated = true;
            questions.forEach(q => {
                if (ratings[q.id] === 0) allRated = false;
            });
            
            if (!allRated) {
                alert('Пожалуйста, оцените все услуги');
                return;
            }
            
            // Собираем данные голоса
            const voteData = {
                address: selectedAddress,
                entrance: entrance || 'не указан',
                ratings: { ...ratings },
                timestamp: new Date().toISOString(),
                id: Date.now() // уникальный идентификатор голоса
            };
            
            // Сохраняем в localStorage
            saveVoteToStorage(voteData);
            
            // Обновляем счетчик голосов
            updateTotalVotes();
            
            // Показываем модальное окно успеха
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
            
            // Очищаем форму
            clearForm();
        }

        // Сохранение в localStorage
        function saveVoteToStorage(voteData) {
            // Получаем существующие голоса
            let votes = JSON.parse(localStorage.getItem('zhkhVotes')) || [];
            votes.push(voteData);
            localStorage.setItem('zhkhVotes', JSON.stringify(votes));
            
            // Сохраняем агрегированные результаты
            saveAggregatedResults(votes);
            
            // Сохраняем статистику по адресам
            saveAddressStats(votes);
        }

        // Сохранение агрегированных результатов
        function saveAggregatedResults(votes) {
            const results = {
                totalVotes: votes.length,
                questionStats: {}
            };
            
            questions.forEach(q => {
                results.questionStats[q.id] = {
                    text: q.text,
                    total: 0,
                    count: 0,
                    average: 0,
                    distribution: {1:0, 2:0, 3:0, 4:0, 5:0}
                };
            });
            
            votes.forEach(vote => {
                Object.entries(vote.ratings).forEach(([qId, rating]) => {
                    if (results.questionStats[qId]) {
                        results.questionStats[qId].total += rating;
                        results.questionStats[qId].count++;
                        results.questionStats[qId].distribution[rating] = 
                            (results.questionStats[qId].distribution[rating] || 0) + 1;
                    }
                });
            });
            
            // Рассчитываем средние
            Object.keys(results.questionStats).forEach(qId => {
                const stat = results.questionStats[qId];
                if (stat.count > 0) {
                    stat.average = stat.total / stat.count;
                }
            });
            
            localStorage.setItem('zhkhResults', JSON.stringify(results));
        }

        // Сохранение статистики по адресам
        function saveAddressStats(votes) {
            const addressStats = {};
            
            // Инициализируем все адреса
            addressList.forEach(address => {
                addressStats[address] = {
                    total: 0,
                    votes: []
                };
            });
            
            // Добавляем голоса
            votes.forEach(vote => {
                if (addressStats[vote.address]) {
                    addressStats[vote.address].total++;
                    addressStats[vote.address].votes.push({
                        ratings: vote.ratings,
                        timestamp: vote.timestamp,
                        entrance: vote.entrance
                    });
                }
            });
            
            localStorage.setItem('zhkhAddressStats', JSON.stringify(addressStats));
        }

        // Обновление счетчика голосов
        function updateTotalVotes() {
            const votes = JSON.parse(localStorage.getItem('zhkhVotes')) || [];
            document.getElementById('totalVotes').textContent = votes.length;
        }

        // Очистка формы
        function clearForm() {
            // Сбрасываем выбор адреса
            document.getElementById('addressSelect').value = '';
            document.getElementById('entrance').value = '';
            
            // Сбрасываем оценки
            questions.forEach(q => {
                ratings[q.id] = 0;
            });
            
            // Перезагружаем звезды
            loadQuestions();
        }

        // Проверка наличия сохраненных данных при загрузке
        function checkExistingData() {
            // Инициализируем хранилище, если оно пустое
            if (!localStorage.getItem('zhkhVotes')) {
                localStorage.setItem('zhkhVotes', JSON.stringify([]));
            }
            if (!localStorage.getItem('zhkhResults')) {
                localStorage.setItem('zhkhResults', JSON.stringify({totalVotes: 0, questionStats: {}}));
            }
            if (!localStorage.getItem('zhkhAddressStats')) {
                const emptyAddressStats = {};
                addressList.forEach(address => {
                    emptyAddressStats[address] = { total: 0, votes: [] };
                });
                localStorage.setItem('zhkhAddressStats', JSON.stringify(emptyAddressStats));
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingData();
            loadQuestions();
            updateTotalVotes();
        });

        // Делаем функции глобальными для вызова из HTML
        window.submitVote = submitVote;
    </script>
</body>
</html>
